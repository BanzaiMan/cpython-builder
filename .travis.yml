language: python

matrix:
  include:
    - sudo: required
      services:
        - docker
      env:
        - RELEASE=trusty
    - sudo: required
      env:
        - RELEASE=precise

env:
  global:
    - VERSION='3.6-dev'
    - ALIAS='nightly'
    - INSTALL_DEST=/opt/python
    - PACKAGES='pip numpy nose pytest mock wheel'

install:
  - pushd /opt/pyenv/
  - sudo git checkout master
  - sudo git pull
  - popd

script:
  - pushd $HOME
  - sudo env PYTHON_BUILD_ROOT=/opt/pyenv/plugins/python-build /opt/pyenv/plugins/python-build/bin/python-build $VERSION $INSTALL_DEST/$VERSION
  - sudo ln -s $INSTALL_DEST/$VERSION $INSTALL_DEST/$ALIAS
  - virtualenv --distribute --python=$INSTALL_DEST/$VERSION/bin/python /home/travis/virtualenv/python$VERSION
  - ln -s $HOME/virtualenv/python$VERSION $HOME/virtualenv/python$ALIAS
  - $HOME/virtualenv/python$VERSION/bin/pip install --upgrade $PACKAGES
  - popd

after_success:
  - mkdir -p $HOME/archive/$(lsb_release -rs)
  - tar cjf $HOME/archive/$(lsb_release -rs)/python-$ALIAS.tar.bz2 $INSTALL_DEST/$VERSION $INSTALL_DEST/$ALIAS $HOME/virtualenv/python$VERSION $HOME/virtualenv/python$ALIAS
  - ls -lh $HOME/archive/$(lsb_release -rs)/python-$ALIAS.tar.bz2

after_failure:
  - cat /tmp/python-build.*.log

before_deploy:
  - git clone https://github.com/travis-ci/dpl.git
  - pushd dpl
  - git config user.email "you@example.com"
  - git config user.name "Your Name"
  - git remote add jw https://github.com/johanneswuerbach/dpl.git
  - git fetch jw
  - git merge --no-edit jw/s3-aws-sdk-v2 master
  - rvm 1.9.3 do gem build dpl.gemspec
  - mv dpl-*.gem $TRAVIS_BUILD_DIR
  - popd

deploy:
  provider: s3
  edge: local
  access_key_id: $ARTIFACTS_KEY
  secret_access_key: $ARTIFACTS_SECRET
  bucket: $ARTIFACTS_BUCKET
  local_dir: $HOME/archive/$(lsb_release -rs)
  upload_dir: $(lsb_release -rs)
  on:
    all_branches: true
  acl: public_read
